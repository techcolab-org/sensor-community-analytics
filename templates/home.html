{% extends 'base.html' %}
{% load leaflet_tags %}
{% load static %}


{% block content %}
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="stat-card rounded-2xl p-5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-map-marker-alt text-4xl text-cyan-400"></i>
            </div>
            <p class="text-gray-400 text-sm font-medium mb-1">Total Stations</p>
            <h3 class="text-3xl font-bold text-white">{{ total_stations }}</h3>
            <div class="mt-2 h-1 w-12 bg-cyan-500 rounded-full"></div>
        </div>

        <div class="stat-card rounded-2xl p-5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <i class="fas fa-microchip text-4xl text-emerald-400"></i>
            </div>
            <p class="text-gray-400 text-sm font-medium mb-1">Active Sensors</p>
            <h3 class="text-3xl font-bold text-white">{{ active_sensors }}</h3>
            <div class="mt-2 h-1 w-12 bg-emerald-500 rounded-full"></div>
        </div>
    </div>

    <!-- Section Header with Tabs -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
        <div class="flex items-center gap-3">
            <i class="fas fa-map-pin text-red-500"></i>
            <h2 class="text-xl font-bold text-white">Station Locations</h2>
            <span class="text-gray-500 text-sm">({{ total_stations }})</span>
        </div>


        <div class="flex gap-3">
            <!-- Trigger Button -->
            <button id="viewStationBtn"
                    onclick="openFileBrowser()"
                    class="px-4 py-2.5 rounded-lg bg-emerald-600/20 hover:bg-emerald-600/30
               text-emerald-400 border border-emerald-500/30 transition-all
               flex items-center gap-2 text-sm font-medium
               {% if not station_path %}hidden{% endif %}">
                <i class="fas fa-eye"></i>
                View Station Data
            </button>

            <button onclick="openStationModal()"
                    class="px-4 py-2 rounded-lg bg-cyan-600/20 hover:bg-cyan-600/30 text-cyan-400 border border-cyan-500/30 transition-all flex items-center gap-2 text-sm font-medium">
                <i class="fas fa-plus"></i>
                Add Station
            </button>
            <button onclick="selectAllStations(this)"
                    class="px-4 py-2 rounded-lg bg-cyan-600/20 hover:bg-cyan-600/30 text-cyan-400 border border-cyan-500/30 transition-all flex items-center gap-2 text-sm font-medium">
                Select All
            </button>
            <button onclick="downloadLocation(this, 'station_name', true)"
                    class="px-4 py-2.5 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-sm font-semibold shadow-lg shadow-cyan-500/20 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-download"></i>
                Download Data
            </button>
        </div>
    </div>

    <!-- Locations Grid -->
    {% include 'location_grid.html' %}

    <!-- Toast Notifications Container -->
    {% include 'toast_container.html' %}

    <!-- Add Station Modal -->
    {% include 'add_station_modal.html' %}

    <!-- Add Sensor Modal -->
    {% include 'add_sensor_modal.html' %}

    {% include 'download_station_data_modal.html' %}

    {% include 'station_data.html' %}

    {% leaflet_js %}
    {% leaflet_css %}

    <script src="{% static 'sensor/js/stations.js' %}"></script>
    <script src="{% static 'sensor/js/modals.js' %}"></script>
    <script src="{% static 'sensor/js/toast.js' %}"></script>


    <!-- Toggle Expandable Sensor List -->
    <script src="{% static 'sensor/js/toggle_sensor_list.js' %}"></script>

    <!-- Download Station and Sensor Data from Sensor Community -->
    <script src="{% static 'sensor/js/download_station_data.js' %}"></script>

    <script>
        // Station data from Django - FIXED VERSION
        let stationsData = [
            {% for station in stations %}
                {
                    id: {{ station.id }},
                    uid: "{{ station.uid|default:station.id|escapejs }}",
                    name: "{{ station.name|escapejs }}",
                    location: "{{ station.location_display_name|escapejs }}",
                    sensorCount: {{ station.get_sensor_data|length|default:0 }},
                    sensors: [
                        {% for sensor in station.get_sensor_data %}
                            {
                                id: {{ sensor.id }},
                                sensor_id: "{{ sensor.sensor_id|escapejs }}",
                                sensor_type: {
                                    name: "{{ sensor.sensor_type.name|escapejs|default:'Unknown' }}"
                                },
                                values: {
                                    {% for key, val in sensor.get_sensor_data_value.items %}
                                        "{{ key|escapejs }}": {
                                            timestamp: "{{ val.timestamp|date:'c' }}",
                                            value: {{ val.value|default:'null' }}
                                        }{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                }
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    coordinates: {% if station.location and station.location.coords %}
                        [{{ station.location.coords.1 }},
                            {{ station.location.coords.0 }}]
                    {% endif %}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]

        console.log('✅ Stations data loaded:', stationsData.length, 'stations');
        console.log('✅ Stations data loaded:', stationsData, 'stations');
    </script>

    <script src="{% static 'sensor/js/search_station.js' %}"></script>

    {% include 'station_detail_modal.html' %}
    <script src="{% static 'sensor/js/station_detail.js' %}"></script>

{% endblock %}
